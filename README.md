# DWH_control_work

# Проектная работа по модулю “DWH”

### Что необходимо сделать?

Источником данных будет база данных bookings. В рамках итоговой работы будет необходимо:

1.	Создать таблицы измерений и таблицу фактов в PostreSQL. Можете развернуть базу данных локально или в Docker-контейнере. В качестве альтернативы можете  таблицы с фактами и размерностями в csv файлы (каждая таблица - отдельный csv-файл), если не удается запустить PostgreSQL.

2.	Наполнить базу данными из бд bookings при помощи ETL

Требуемые таблицы:

**Fact_Flights** - содержит совершенные перелеты. Если в рамках билета был сложный маршрут с пересадками - каждый сегмент учитываем независимо

●	Пассажир

●	Дата и время вылета (факт)

●	Дата и время прилета (факт)

●	Задержка вылета (разница между фактической и запланированной датой в секундах)

●	Задержка прилета (разница между фактической и запланированной датой в секундах)

●	Самолет

●	Аэропорт вылета

●	Аэропорт прилета

●	Класс обслуживания

●	Стоимость


**Dim_Calendar** - справочник дат

**Dim_Passengers** - справочник пассажиров

**Dim_Aircrafts** - справочник самолетов

**Dim_Airports** - справочник аэропортов

**Dim_Tariff** - справочник тарифов (Эконом/бизнес и тд)


***Наполнение базы данными из БД bookings осуществляется с помощью задания, состоящего из 3 трансформаций:***

1) создание структуры новой базы + представления в bookings, с помощью которого будет производиться заливка данных в таблицу фактов. Поскольку в задаче прописано создать таблицы уже совершенных перелетов, в представлении необходимо прописать условие "where actual_arrival is not null".
Таблица dim_calendar создается с помощью функции generate_series, от условной даты до сегодняшнего дня, получаемого функцией now(). Также добавлены поля для идентификации номера дня недели, номера дня месяца, номера недели в году, номера месяца и номера года.

2) формирование датасетов из базы bookings, маппинг и заливка их в таблицы измерений. Также каждый датасет сохранен в отдельный csv файл.

3) формирование датасета из созданного представления в старой базе и созданной таблицы измерений пассажиров. Это сделано для экономии времени, т.к. в случае обновления по id пассажиров это занимает около получаса. Исходя из этого, целесообразнее сделать join по пассажирам сразу, а обновление по другим параметрам можно делать в процессе трансформации. Следующий шаг select values убирает лишние поля и оставляет только нужные.
Далее с помощью шага "калькулятор" создаются поля с данными по задержке вылетов и прилетов, далее - шаги Combination lookup/update по остальным параметрам. Цель этих шагов - создать корректные внешние ключи по всем полям, чтоб таблица fact_flights имела ссылочную целостность с таблицами измерений.
Перед заливкой данных в таблицу фактов созданные технические поля с id параметров следует переименовать в человекочитаемые поля для финального маппинга. После этого происходит заливка данных в таблицу фактов.

Задача осуществляется при помощи задания потому, что для каждой трансформации необходимо удачное завершение предыдущей трансформации. Следовательно, решить задачу с помощью одной трансформации будет сложно, задание намного более удобно. Для удоства решения задачи SQL скрипт создания структуры базы выполняется не запуском отдельного SQL файла, а внедрен в первый шаг задания.


***Все проверки качества данных реализованы в скрипте создания таблиц измерений и таблицы фактов.***

1) dim_passengers:
проверки на ненулевые значения полей (кроме  email, т.к. его может и не быть), также passenger_id - unique,
проверка на правильность написания паспортных данных с помощью соответствия регулярному выражению "4 цифры, пробел, 6 цифр",
аналогичная проверка на правильность написания телефона, "+, любые цифры, от 8 до 20 символов",

2) dim_aircrafts:
проверки на ненулевые значения полей, плюс aircraft_code - unique,
проверка на длительность полета, больше 0 и меньше 30000 км (условно),

3) dim_airports:
проверки на ненулевые значения полей, плюс airport_code - unique,
проверка на отсутствие цифр в коде аэропорта, с помощью соответствия регулярному выражению "трижды исключить любые цифры", т.к. формат char(3),
проверка на вхождение региона в условный список регионов, с помощью функции split_part, которая из поля timezone отсекает данные до разделителя и берет первую часть,
проверка на уникальное сочетание полей longitude и latitude,

4) dim_tariff:
проверка на ненулевое значение поля tariff, а также unique,
проверка на вхождение тарифа в список тарифов Эконом, Бизнес и Комфорт,

5 fact_flights:
проверки на ненулевые значения полей,
проверка на то, что аэропорт отправления не может быть равен аэропорту прибытия,
проверка на то, что поле actual_departure меньше либо равно текущему времени, с помощью функции now(),
проверка на то, что поле amount больше нуля

### Файлы формата .ktl и .kjb можно открыть с помощью утилиты Spoon от Pentaho Data Integration.
- create_base.ktr
- input_data_to_dimensions.ktr
- main_transform.ktr
- Проектная_работа.kjb
